const swaggerJsdoc = require('swagger-jsdoc');
const swaggerUi = require('swagger-ui-express');

const options = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'H·ªá th·ªëng Qu·∫£n l√Ω Th·ª±c t·∫≠p - API Documentation',
      version: '1.0.0',
      description: `
        API Documentation cho H·ªá th·ªëng Qu·∫£n l√Ω Th·ª±c t·∫≠p - Khoa CNTT ƒê·∫°i h·ªçc ƒê·∫°i Nam
        
        ## üéØ T√≠nh nƒÉng ch√≠nh:
        - **Qu·∫£n l√Ω t√†i kho·∫£n**: Admin, Sinh vi√™n, Gi·∫£ng vi√™n, Doanh nghi·ªáp
        - **Qu·∫£n l√Ω th·ª±c t·∫≠p**: ƒê·ª£t th·ª±c t·∫≠p, ph√¢n c√¥ng, theo d√µi
        - **B√°o c√°o**: Tu·∫ßn, cu·ªëi k·ª≥, th·ªëng k√™
        - **Import/Export**: Excel templates, bulk operations
        
        ## üîê Authentication:
        1) ƒêƒÉng nh·∫≠p ƒë·ªÉ l·∫•y token t·∫°i m·ªôt trong c√°c endpoint:
           - POST /api/auth/login (body: { userCode, password })
           - POST /api/auth/login/admin (body: { userId, password })
           - POST /api/auth/login/sinh-vien (body: { maSinhVien, password })
        2) Click n√∫t "Authorize" (g√≥c ph·∫£i tr√™n) v√† d√°n token (kh√¥ng c·∫ßn g√µ ch·ªØ "Bearer ")
        3) Swagger s·∫Ω t·ª± g·ª≠i header \`Authorization: Bearer <token>\` cho c√°c API y√™u c·∫ßu x√°c th·ª±c
        
        L∆∞u √Ω: Token c√≥ h·∫°n d√πng (~24h). N·∫øu token c≈©, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.
        
        ## üì± Li√™n h·ªá:
        - **Email**: admin@dainam.edu.vn
        - **Website**: https://dainam.edu.vn
      `,
      contact: {
        name: 'Khoa CNTT - ƒê·∫°i h·ªçc ƒê·∫°i Nam',
        email: 'admin@dainam.edu.vn',
        url: 'https://dainam.edu.vn'
      },
      license: {
        name: 'MIT',
        url: 'https://opensource.org/licenses/MIT'
      }
    },
    servers: [
      {
        url: 'http://localhost:3001',
        description: 'Development Server'
      },
      {
        url: 'https://api.dainam.edu.vn',
        description: 'Production Server'
      }
    ],
    security: [
      { bearerAuth: [] }
    ],
    components: {
      securitySchemes: {
        bearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'JWT',
          description: 'JWT Authorization header using the Bearer scheme'
        }
      },
      schemas: {
        // Common schemas
        ApiResponse: {
          type: 'object',
          properties: {
            success: {
              type: 'boolean',
              description: 'Tr·∫°ng th√°i th√†nh c√¥ng'
            },
            message: {
              type: 'string',
              description: 'Th√¥ng b√°o'
            },
            data: {
              type: 'object',
              description: 'D·ªØ li·ªáu tr·∫£ v·ªÅ'
            },
            error: {
              type: 'string',
              description: 'Th√¥ng b√°o l·ªói (n·∫øu c√≥)'
            }
          }
        },
        
        // Auth schemas
        LoginRequest: {
          type: 'object',
          required: ['userId', 'password', 'role'],
          properties: {
            userId: {
              type: 'string',
              description: 'M√£ ƒëƒÉng nh·∫≠p',
              example: 'SV001'
            },
            password: {
              type: 'string',
              description: 'M·∫≠t kh·∫©u',
              example: '123456'
            },
            role: {
              type: 'string',
              enum: ['admin', 'sinh-vien', 'giang-vien', 'doanh-nghiep'],
              description: 'Vai tr√≤ ng∆∞·ªùi d√πng',
              example: 'sinh-vien'
            }
          }
        },
        
        LoginResponse: {
          type: 'object',
          properties: {
            success: { type: 'boolean' },
            message: { type: 'string' },
            data: {
              type: 'object',
              properties: {
                token: { type: 'string', description: 'JWT Token' },
                user: {
                  type: 'object',
                  properties: {
                    id: { type: 'integer' },
                    userId: { type: 'string' },
                    role: { type: 'string' },
                    name: { type: 'string' }
                  }
                }
              }
            }
          }
        },

        // User schemas
        SinhVien: {
          type: 'object',
          properties: {
            id: { type: 'integer', description: 'ID sinh vi√™n' },
            ma_sinh_vien: { type: 'string', description: 'M√£ sinh vi√™n' },
            ho_ten: { type: 'string', description: 'H·ªç t√™n' },
            email: { type: 'string', description: 'Email' },
            so_dien_thoai: { type: 'string', description: 'S·ªë ƒëi·ªán tho·∫°i' },
            lop: { type: 'string', description: 'L·ªõp' },
            khoa: { type: 'string', description: 'Khoa' },
            nam_hoc: { type: 'string', description: 'NƒÉm h·ªçc' },
            vi_tri_muon_ung_tuyen_thuc_tap: { type: 'string', description: 'V·ªã tr√≠ mu·ªën ·ª©ng tuy·ªÉn' },
            don_vi_thuc_tap: { type: 'string', description: 'ƒê∆°n v·ªã th·ª±c t·∫≠p' },
            trang_thai: { 
              type: 'string', 
              enum: ['chua-thuc-tap', 'dang-thuc-tap', 'hoan-thanh', 'tam-dung'],
              description: 'Tr·∫°ng th√°i th·ª±c t·∫≠p'
            },
            created_at: { type: 'string', format: 'date-time' },
            updated_at: { type: 'string', format: 'date-time' }
          }
        },

        DoanhNghiep: {
          type: 'object',
          properties: {
            id: { type: 'integer' },
            ma_doanh_nghiep: { type: 'string' },
            ten_doanh_nghiep: { type: 'string' },
            dia_chi: { type: 'string' },
            so_dien_thoai: { type: 'string' },
            email: { type: 'string' },
            website: { type: 'string' },
            nguoi_lien_he: { type: 'string' },
            chuc_vu_lien_he: { type: 'string' },
            linh_vuc: { type: 'string' },
            quy_mo: { type: 'string' },
            mo_ta: { type: 'text' },
            trang_thai: {
              type: 'string',
              enum: ['hoat-dong', 'tam-dung', 'khong-hop-tac']
            }
          }
        },

        GiangVien: {
          type: 'object',
          properties: {
            id: { type: 'integer' },
            ma_giang_vien: { type: 'string' },
            ho_ten: { type: 'string' },
            email: { type: 'string' },
            so_dien_thoai: { type: 'string' },
            khoa: { type: 'string' },
            chuyen_mon: { type: 'string' },
            trinh_do: { type: 'string' }
          }
        },

        // Report schemas
        BaoCaoThucTap: {
          type: 'object',
          properties: {
            id: { type: 'integer' },
            sinh_vien_id: { type: 'integer' },
            tuan_thu: { type: 'integer' },
            noi_dung: { type: 'string' },
            van_de_gap_phai: { type: 'string' },
            ke_hoach_tuan_sau: { type: 'string' },
            diem_giang_vien: { type: 'number', minimum: 0, maximum: 10 },
            diem_doanh_nghiep: { type: 'number', minimum: 0, maximum: 10 },
            nhan_xet_giang_vien: { type: 'string' },
            nhan_xet_doanh_nghiep: { type: 'string' },
            trang_thai: {
              type: 'string',
              enum: ['chua-nop', 'cho-duyet', 'da-duyet', 'can-sua']
            },
            ngay_nop: { type: 'string', format: 'date-time' }
          }
        },

        // Error schemas
        ValidationError: {
          type: 'object',
          properties: {
            success: { type: 'boolean', example: false },
            message: { type: 'string', example: 'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá' },
            errors: {
              type: 'array',
              items: {
                type: 'object',
                properties: {
                  field: { type: 'string' },
                  message: { type: 'string' }
                }
              }
            }
          }
        },

        UnauthorizedError: {
          type: 'object',
          properties: {
            success: { type: 'boolean', example: false },
            message: { type: 'string', example: 'Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p' }
          }
        },

        NotFoundError: {
          type: 'object',
          properties: {
            success: { type: 'boolean', example: false },
            message: { type: 'string', example: 'Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu' }
          }
        }
      },
      responses: {
        ValidationError: {
          description: 'L·ªói validation d·ªØ li·ªáu',
          content: {
            'application/json': {
              schema: { $ref: '#/components/schemas/ValidationError' }
            }
          }
        },
        UnauthorizedError: {
          description: 'Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p',
          content: {
            'application/json': {
              schema: { $ref: '#/components/schemas/UnauthorizedError' }
            }
          }
        },
        NotFoundError: {
          description: 'Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu',
          content: {
            'application/json': {
              schema: { $ref: '#/components/schemas/NotFoundError' }
            }
          }
        },
        ServerError: {
          description: 'L·ªói server',
          content: {
            'application/json': {
              schema: {
                type: 'object',
                properties: {
                  success: { type: 'boolean', example: false },
                  message: { type: 'string', example: 'L·ªói server' }
                }
              }
            }
          }
        }
      }
    },
    security: [
      {
        bearerAuth: []
      }
    ],
    tags: [
      {
        name: 'Authentication',
        description: 'üîê X√°c th·ª±c v√† ph√¢n quy·ªÅn'
      },
      {
        name: 'Admin',
        description: 'üë®‚Äçüíº Qu·∫£n l√Ω h·ªá th·ªëng'
      },
      {
        name: 'Sinh Vi√™n',
        description: 'üë®‚Äçüéì Qu·∫£n l√Ω sinh vi√™n'
      },
      {
        name: 'Gi·∫£ng Vi√™n',
        description: 'üë®‚Äçüè´ Qu·∫£n l√Ω gi·∫£ng vi√™n'
      },
      {
        name: 'Doanh Nghi·ªáp',
        description: 'üè¢ Qu·∫£n l√Ω doanh nghi·ªáp'
      },
      {
        name: 'B√°o C√°o',
        description: 'üìä B√°o c√°o th·ª±c t·∫≠p'
      },
      {
        name: 'Import/Export',
        description: 'üìÅ Import/Export d·ªØ li·ªáu'
      },
      {
        name: 'Utilities',
        description: 'üîß Ti·ªán √≠ch h·ªá th·ªëng'
      }
    ]
  },
  apis: [
    './src/routes/*.js',
    './src/controllers/*.js',
    './server.js'
  ]
};

const specs = swaggerJsdoc(options);

// Custom CSS ƒë·ªÉ l√†m ƒë·∫πp Swagger UI
const customCss = `
  .swagger-ui .topbar { display: none }
  .swagger-ui .info { margin: 20px 0; }
  .swagger-ui .info .title { 
    color: #1f2937; 
    font-size: 2.5rem;
    font-weight: bold;
  }
  .swagger-ui .info .description { 
    color: #4b5563; 
    font-size: 1.1rem;
    line-height: 1.6;
  }
  .swagger-ui .scheme-container { 
    background: #f3f4f6; 
    padding: 20px; 
    border-radius: 8px;
    margin: 20px 0;
  }
  .swagger-ui .opblock .opblock-summary { 
    border-left: 4px solid #3b82f6;
    padding-left: 15px;
  }
  .swagger-ui .opblock.opblock-get .opblock-summary { 
    border-left-color: #10b981; 
  }
  .swagger-ui .opblock.opblock-post .opblock-summary { 
    border-left-color: #3b82f6; 
  }
  .swagger-ui .opblock.opblock-put .opblock-summary { 
    border-left-color: #f59e0b; 
  }
  .swagger-ui .opblock.opblock-delete .opblock-summary { 
    border-left-color: #ef4444; 
  }
  .swagger-ui .btn.authorize { 
    background: #3b82f6;
    border-color: #3b82f6;
  }
  .swagger-ui .btn.authorize:hover { 
    background: #2563eb;
    border-color: #2563eb;
  }
`;

const swaggerOptions = {
  customCss,
  customSiteTitle: 'API Docs - Qu·∫£n l√Ω Th·ª±c t·∫≠p',
  customfavIcon: '/favicon.ico',
  swaggerOptions: {
    persistAuthorization: true,
    displayRequestDuration: true,
    filter: true,
    tryItOutEnabled: true,
    requestInterceptor: (req) => {
      req.headers['X-Requested-With'] = 'SwaggerUI';
      return req;
    }
  }
};

module.exports = {
  specs,
  swaggerUi,
  swaggerOptions
};